<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.limyel.shutbb.dao.PostDao">
    <sql id="insertFields">(content, draft, user_id, topic_id)</sql>
    <sql id="retriveFields">
        id, created_at, updated_at, content, user_id
    </sql>
    <sql id="allFields">
        id, created_at, updated_at, deleted, content, user_id, topic_id, draft, target_id, floor
    </sql>
    <sql id="allFieldsP">
        p.id, p.created_at, p.updated_at, p.deleted, p.content, p.user_id, p.topic_id, p.draft, p.target_id, p.floor
    </sql>

    <resultMap id="post" type="post">
        <id property="id" column="id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
        <result property="content" column="content"/>
        <result property="draft" column="draft"/>
        <result property="floor" column="floor"/>
<!--        <association property="target" column="target" javaType="post">-->
<!--            <id property="id" column="id"/>-->
<!--            <result property="content" column="content"/>-->
<!--            <association property="user" column="user_id" javaType="user">-->
<!--                <id property="id" column="id"/>-->
<!--                <result property="username" column="username"/>-->
<!--            </association>-->
<!--        </association>-->
        <association property="target" column="target_id" select="retriveById"/>
        <association property="user" column="user_id" javaType="user">
            <id property="id" column="id"/>
            <result property="username" column="username"/>
            <result property="status" column="status"/>
            <result property="avatar" column="avatar"/>
        </association>
        <association property="topic" column="topic_id" javaType="topic">
            <id property="id" column="id"/>
            <result property="title" column="title"/>
        </association>
    </resultMap>

    <insert id="create" parameterType="post" keyColumn="id" keyProperty="id">
        insert into post (content, draft, user_id, topic_id, floor<if test="target != null">, target_id</if>) values (#{content}, #{draft}, #{user.id}, #{topic.id}, countFloor(#{topic.id})<if test="target != null">, #{target.id}</if>)
    </insert>

    <select id="retriveById" resultMap="post">
        select <include refid="allFieldsP"/>, u.id, u.status, u.username, u.avatar from post p, user u where p.id=#{id} and u.id=p.user_id
    </select>

    <select id="retriveByTopic" resultMap="post">
        select <include refid="allFieldsP"/>, u.id, u.username, u.status, u.avatar, t.id, t.title from post p, user u, topic t where p.deleted=false and p.draft=false and p.topic_id=#{id} and u.id=p.user_id and t.id=p.topic_id order by created_at
    </select>

    <select id="retriveByUser" resultType="com.limyel.shutbb.entity.Post">
        select <include refid="allFields"/> from post where deleted=false and draft=false and user_id=#{userId}
    </select>

    <select id="retriveDraft" resultType="com.limyel.shutbb.entity.Post">
        select <include refid="retriveFields"/> from post where deleted=false and draft=true and user_id=#{userId}
    </select>

    <select id="retriveLatest" resultMap="post">
        select <include refid="allFieldsP"/>, u.id, u.status, u.avatar, u.username from post p, user u where p.topic_id=#{topicId} and u.id=p.user_id order by created_at desc limit 1
    </select>

    <update id="update" parameterType="post">
        update post
        <set>
            <if test="content != null">content=#{content},</if>
            <if test="isDraft != null">draft=#{isDraft},</if>
        </set>
    </update>

    <update id="deleteById">
        update post set deleted=true where id=#{id} and user_id=#{user.id}
    </update>

    <select id="countByTopic" resultType="integer">
        select count(id) from post where topic_id=#{topicId}
    </select>
</mapper>